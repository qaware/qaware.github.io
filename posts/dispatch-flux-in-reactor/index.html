<!doctype html><html lang=en><head><title>How to dispatch flux to worker in Reactor - QAware | Software Engineering Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=yes"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="This post shows how to dispatch a flux of items to services of separated functional domains when using Reactor in Java."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="How to dispatch flux to worker in Reactor"><meta property="og:description" content="This post shows how to dispatch a flux of items to services of separated functional domains when using Reactor in Java."><meta property="og:url" content="https://blog.qaware.de/posts/dispatch-flux-in-reactor/"><meta property="og:image" content="https://blog.qaware.de/images/images/qaware_logo.png"><link rel=apple-touch-icon sizes=180x180 href=https://blog.qaware.de/images/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.qaware.de/images/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.qaware.de/images/icons/favicon-16x16.png><link rel=manifest href=https://blog.qaware.de/images/icons/site.webmanifest><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=icon href=/QAware_Logo_Icon_RGB_Petrol.svg type=image/svg+xml><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><link rel=canonical href=https://blog.qaware.de/posts/dispatch-flux-in-reactor/><link rel=stylesheet href=https://blog.qaware.de/css/main.098c0e189cad2e9f36cf297e63d68287a9f1e1ba37b72c316aafe78722aca094738d3238a359d91fca3eb48fc356b73c7e436c50fac13d61ddfa699fca90005d.css integrity='sha512-CYwOGJytLp82zyl+Y9aCh6nx4bo3tywxaq/nhyKsoJRzjTI4o1nZH8o+tI/DVrc8fkNsUPrBPWHd+mmfypAAXQ==' title=templateStyle><script id=Cookiebot src=https://consent.cookiebot.com/uc.js data-cbid=4e938949-aa56-465e-9c2a-175bb6c31d81 data-blockingmode=auto type=text/javascript></script></head><body><header><div id=main-header><a href=/ id=main-header-logo><img src=/images/icons/logo_qaware.svg alt=QAware id=main-header-logo-img></a><div id=main-header-nav-items-container><nav id=main-nav><ul class=main-nav-menu><li class=main-nav-menu><a href=https://blog.qaware.de/ class="main-nav-menu nav-item">Posts</a><ul class=main-nav-sub-menu><li class=main-nav-sub-menu><a href=https://blog.qaware.de/tags/ class="main-nav-sub-menu nav-item">Tags</a></li><li class=main-nav-sub-menu><a href=https://blog.qaware.de/posts/ class="main-nav-sub-menu nav-item">Archive</a></li></ul></li><li class=main-nav-menu><a href=https://blog.qaware.de/ class="main-nav-menu nav-item">Resources</a><ul class=main-nav-sub-menu><li class=main-nav-sub-menu><a href=https://www.github.com/qaware class=main-nav-sub-menu>GitHub</a></li><li class=main-nav-sub-menu><a href=https://de.slideshare.net/QAware class=main-nav-sub-menu>SlideShare</a></li><li class=main-nav-sub-menu><a href=https://www.youtube.com/user/QAwareGmbH class=main-nav-sub-menu>YouTube</a></li><li class=main-nav-sub-menu><a href=https://www.meetup.com/de-DE/Cloud-Native-Night class=main-nav-sub-menu>Meetup Mainz</a></li><li class=main-nav-sub-menu><a href=https://www.meetup.com/de-DE/cloud-native-muc/ class=main-nav-sub-menu>Meetup Munich</a></li></ul></li><li class=main-nav-menu><a href=https://www.qaware.de class=main-nav-menu>Company</a><ul class=main-nav-sub-menu><li class=main-nav-sub-menu><a href=https://www.qaware.de class=main-nav-sub-menu>Website</a></li><li class=main-nav-sub-menu><a href=https://twitter.com/qaware class=main-nav-sub-menu>Twitter</a></li><li class=main-nav-sub-menu><a href=http://www.linkedin.com/company/qaware-gmbh class=main-nav-sub-menu>Linkedin</a></li><li class=main-nav-sub-menu><a href=http://www.xing.com/companies/qawaregmbh class=main-nav-sub-menu>Xing</a></li><li class=main-nav-sub-menu><a href=http://www.kununu.com/qaware class=main-nav-sub-menu>Kununu</a></li></ul></li><li class=main-nav-menu><a href=https://www.qaware.de/kontakt class=main-nav-menu>Contact</a></li></ul></nav><a id=mobile-nav-icon-link href=#><div id=mobile-nav-icon></div></a></div></div><div id=mobile-nav-dropdown><nav id=mobile-nav class="mobile-nav collapsed"><ul><li><a href=https://blog.qaware.de/ class=nav-item>Posts</a><ul><li><a href=https://blog.qaware.de/tags/ class=nav-item>Tags</a></li><li><a href=https://blog.qaware.de/posts/ class=nav-item>Archive</a></li></ul></li><li><a href=https://blog.qaware.de/ class=nav-item>Resources</a><ul><li><a href=https://www.github.com/qaware>GitHub</a></li><li><a href=https://de.slideshare.net/QAware>SlideShare</a></li><li><a href=https://www.youtube.com/user/QAwareGmbH>YouTube</a></li><li><a href=https://www.meetup.com/de-DE/Cloud-Native-Night>Meetup Mainz</a></li><li><a href=https://www.meetup.com/de-DE/cloud-native-muc/>Meetup Munich</a></li></ul></li><li><a href=https://www.qaware.de class=nav-item>Company</a><ul><li><a href=https://www.qaware.de>Website</a></li><li><a href=https://twitter.com/qaware>Twitter</a></li><li><a href=http://www.linkedin.com/company/qaware-gmbh>Linkedin</a></li><li><a href=http://www.xing.com/companies/qawaregmbh>Xing</a></li><li><a href=http://www.kununu.com/qaware>Kununu</a></li></ul></li><li><a href=https://www.qaware.de/kontakt class=nav-item>Contact</a></li></ul></nav></div></header><main><div class='wrap mt-4 post'><div><p class='post_date pale'>11. March 2019</p><h1 class=post_title>How to dispatch flux to worker in Reactor</h1><p class=pale>by Andreas Grub | 1498 words | ~8 min read</p><p><a class=post_tag href=/tags/flux/>flux</a>
<a class=post_tag href=/tags/reactor/>reactor</a>
<a class=post_tag href=/tags/java/>java</a>
<a class=post_tag href=/tags/reactive/>reactive</a></p><div class=post_body><div class=post_inner><p>This post shows how to dispatch a flux of items to services of separated functional domains when using <a href=https://projectreactor.io/>Reactor</a> in Java. The author encountered this problem while developing a larger reactive application, where a strict separation of different domains of the application is key to maintain a clean architecture.</p><p>Reactor is a library for developing reactive applications and its <a href=https://projectreactor.io/docs/core/release/reference/>reference guide</a> is a good read to understand the basic principles of reactive programming.</p><p>The examples the author found for Reactor, or for other reactive libraries, show how to deal with a flux of items without mentioning how to dispatch and share this flux among separated functional domains. When mapping a flux to one functional domain, there is no obvious way to obtain the original flux to map it to another function domain. In the following, an example will detail the problem and present a solution for the Reactor library.</p><h2 id=an-example-application>An example application</h2><p>This section introduces an example application which will be transformed later to a reactive one. It will dispatch some deletion tasks to independent services, which is a common feature of larger software systems.
A customer is represented by (the usual Java boiler plate such as <code>getters, setters, equals, hashCode, toString</code> is omitted)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Customer</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>CustomerId</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>AccountId</span> <span class=n>account</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>invoices</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>A customer has its own account and a set of associated invoices. The classes <code>CustomerId, AccountId, InvoiceId</code> here are simple wrapper classes to uniquely identify the corresponding entities.</p><p>A service supposed to delete a set of customers has the interface</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>CustomerService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>deleteCustomers</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>An implementation of CustomerService should take care of deleting the account and the invoices as well.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CustomerServiceImpl</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>deleteCustomers</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Set</span><span class=o>&lt;</span><span class=n>Customer</span><span class=o>&gt;</span> <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>customerRepository</span>
</span></span><span class=line><span class=cl>               <span class=o>.</span><span class=na>deleteCustomersByIds</span><span class=o>(</span><span class=n>customerIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>Set</span><span class=o>&lt;</span><span class=n>AccountId</span><span class=o>&gt;</span> <span class=n>toBeDeletedAccounts</span> <span class=o>=</span> <span class=n>deletedCustomers</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>Customer</span><span class=o>::</span><span class=n>getAccount</span><span class=o>)</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toSet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=n>Set</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>toBeDeletedInvoices</span> <span class=o>=</span> <span class=n>deletedCustomers</span><span class=o>.</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>flatMap</span><span class=o>(</span><span class=n>customer</span> <span class=o>-&gt;</span> <span class=n>customer</span><span class=o>.</span><span class=na>getInvoices</span><span class=o>().</span><span class=na>stream</span><span class=o>())</span>
</span></span><span class=line><span class=cl>              <span class=o>.</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>toSet</span><span class=o>());</span>
</span></span><span class=line><span class=cl>      <span class=n>accountService</span><span class=o>.</span><span class=na>deleteAccounts</span><span class=o>(</span><span class=n>toBeDeletedAccounts</span><span class=o>);</span>
</span></span><span class=line><span class=cl>      <span class=n>invoiceService</span><span class=o>.</span><span class=na>deleteInvoices</span><span class=o>(</span><span class=n>toBeDeletedInvoices</span><span class=o>);</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The deletion of the customers itself is delegated to an underlying <code>customerRepository</code>, which returns a collection of the deleted customers for further processing (this &ldquo;find and delete&rdquo; pattern is common for NoSQL databases, such as MongoDB).</p><p>Furthermore, the deletion of the associated accounts and invoices are delegated to the respective <code>accountService</code> and <code>invoiceService</code>, which have the following interface:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>AccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>deleteAccounts</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>AccountId</span><span class=o>&gt;</span> <span class=n>accountIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>InvoiceService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>deleteInvoices</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>invoiceIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Note that this example application has clearly separated domains, which are the customers, the invoices and the accounts.</p><h2 id=reactive-interfaces>Reactive interfaces</h2><p>Turning the service interfaces into reactive services is straight forward:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ReactiveAccountService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=nf>deleteAccounts</span><span class=o>(</span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>AccountId</span><span class=o>&gt;</span> <span class=n>accountIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ReactiveInvoiceService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=nf>deleteInvoices</span><span class=o>(</span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>invoiceIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ReactiveCustomerRepository</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>Customer</span><span class=o>&gt;</span> <span class=nf>deleteCustomersByIds</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>ReactiveCustomerService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=nf>deleteCustomers</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Note that returning a <code>Mono&lt;Void></code> is the reactive way of telling the caller that the requested operation has completed (with or without errors). Also note that the input to the <code>ReactiveCustomerRepository</code> stays non-reactive, as we want to focus on the reactive implementation of the <code>CustomerService</code> in combination with <code>ReactiveAccountService</code> and <code>ReactiveInvoiceService</code>.</p><h2 id=reactive-implementation>Reactive implementation</h2><h3 id=a-first-attempt>A first attempt</h3><p>A first attempt to implement <code>CustomerService</code> reactively could lead to the following code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=nf>deleteCustomers</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>Customer</span><span class=o>&gt;</span> <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>reactiveCustomerRepository</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>deleteCustomersByIds</span><span class=o>(</span><span class=n>customerIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>AccountId</span><span class=o>&gt;</span> <span class=n>toBeDeletedAccounts</span> <span class=o>=</span> <span class=n>deletedCustomers</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>Customer</span><span class=o>::</span><span class=n>getAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>accountsDeleted</span> <span class=o>=</span> <span class=n>reactiveAccountService</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>deleteAccounts</span><span class=o>(</span><span class=n>toBeDeletedAccounts</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>toBeDeletedInvoices</span> <span class=o>=</span> <span class=n>deletedCustomers</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>flatMap</span><span class=o>(</span><span class=n>customer</span> <span class=o>-&gt;</span> <span class=n>Flux</span><span class=o>.</span><span class=na>fromIterable</span><span class=o>(</span><span class=n>customer</span><span class=o>.</span><span class=na>getInvoices</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>invoicesDeleted</span> <span class=o>=</span> <span class=n>reactiveInvoiceService</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>deleteInvoices</span><span class=o>(</span><span class=n>toBeDeletedInvoices</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Flux</span><span class=o>.</span><span class=na>merge</span><span class=o>(</span><span class=n>accountsDeleted</span><span class=o>,</span> <span class=n>invoicesDeleted</span><span class=o>).</span><span class=na>then</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>However, when using the following dummy implementation for the <code>reactiveCustomerRepository</code>,</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Flux</span><span class=o>&lt;</span><span class=n>Customer</span><span class=o>&gt;</span> <span class=nf>deleteCustomersByIds</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>generatedNumbers</span> <span class=o>=</span> <span class=n>Flux</span><span class=o>.</span><span class=na>generate</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=o>()</span> <span class=o>-&gt;</span> <span class=mi>0</span><span class=o>,</span>
</span></span><span class=line><span class=cl>            <span class=o>(</span><span class=n>state</span><span class=o>,</span> <span class=n>sink</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Generating &#34;</span> <span class=o>+</span> <span class=n>state</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>sink</span><span class=o>.</span><span class=na>next</span><span class=o>(</span><span class=n>state</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=o>(</span><span class=n>state</span> <span class=o>==</span> <span class=n>customerIds</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>-</span> <span class=mi>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>sink</span><span class=o>.</span><span class=na>complete</span><span class=o>();</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>state</span> <span class=o>+</span> <span class=mi>1</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>generatedNumbers</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>doOnSubscribe</span><span class=o>(</span><span class=n>subscription</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Subscribed to repository source&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>})</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>i</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>CustomerId</span> <span class=n>id</span> <span class=o>=</span> <span class=k>new</span> <span class=n>CustomerId</span><span class=o>(</span><span class=s>&#34;Customer &#34;</span> <span class=o>+</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>createDummyCustomerFromId</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>});</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>the following output is obtained:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Subscribed to repository source
</span></span><span class=line><span class=cl>Generating 0
</span></span><span class=line><span class=cl>Deleting account AccountId[id=Account CustomerId[id=Customer 0]]
</span></span><span class=line><span class=cl>Generating 1
</span></span><span class=line><span class=cl>Deleting account AccountId[id=Account CustomerId[id=Customer 1]]
</span></span><span class=line><span class=cl>Generating 2
</span></span><span class=line><span class=cl>Deleting account AccountId[id=Account CustomerId[id=Customer 2]]
</span></span><span class=line><span class=cl>Subscribed to repository source
</span></span><span class=line><span class=cl>Generating 0
</span></span><span class=line><span class=cl>Deleting invoice InvoiceId[id=Invoice CustomerId[id=Customer 0]]
</span></span><span class=line><span class=cl>Generating 1
</span></span><span class=line><span class=cl>Deleting invoice InvoiceId[id=Invoice CustomerId[id=Customer 1]]
</span></span><span class=line><span class=cl>Generating 2
</span></span><span class=line><span class=cl>Deleting invoice InvoiceId[id=Invoice CustomerId[id=Customer 2]]
</span></span></code></pre></td></tr></table></div></div><p>This might be surprising as the <code>reactiveCustomerRepository</code> is requested twice to generate the customer. If the repository wasn’t a dummy implementation here, the account deletion would have consumed all those <code>deletedCustomers</code>, and the subsequent invoice deletion would have worked on a completed stream (meaning doing nothing at all). This is certainly undesired behavior.</p><h3 id=handling-multiple-subscribers>Handling multiple subscribers</h3><p>The reference documentation has an answer to this problem: Broadcasting to multiple subscribers with <code>.publish()</code>. The failing attempt should thus be modified as follows</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=nf>deleteCustomers</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>CustomerId</span><span class=o>&gt;</span> <span class=n>customerIds</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>Customer</span><span class=o>&gt;</span> <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>reactiveCustomerRepository</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>deleteCustomersByIds</span><span class=o>(</span><span class=n>customerIds</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>deletedCustomers</span><span class=o>.</span><span class=na>publish</span><span class=o>().</span><span class=na>autoConnect</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>AccountId</span><span class=o>&gt;</span> <span class=n>toBeDeletedAccounts</span> <span class=o>=</span> <span class=n>deletedCustomers</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>Customer</span><span class=o>::</span><span class=n>getAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>accountsDeleted</span> <span class=o>=</span> <span class=n>reactiveAccountService</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>deleteAccounts</span><span class=o>(</span><span class=n>toBeDeletedAccounts</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>Flux</span><span class=o>.</span><span class=na>merge</span><span class=o>(</span><span class=n>deletedCustomers</span><span class=o>,</span> <span class=n>accountsDeleted</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>customer</span> <span class=o>-&gt;</span> <span class=o>(</span><span class=n>Customer</span><span class=o>)</span><span class=n>customer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>deletedCustomers</span><span class=o>.</span><span class=na>publish</span><span class=o>().</span><span class=na>autoConnect</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>toBeDeletedInvoices</span> <span class=o>=</span> <span class=n>deletedCustomers</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>flatMap</span><span class=o>(</span><span class=n>customer</span> <span class=o>-&gt;</span> <span class=n>Flux</span><span class=o>.</span><span class=na>fromIterable</span><span class=o>(</span><span class=n>customer</span><span class=o>.</span><span class=na>getInvoices</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>    <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>invoicesDeleted</span> <span class=o>=</span> <span class=n>reactiveInvoiceService</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>deleteInvoices</span><span class=o>(</span><span class=n>toBeDeletedInvoices</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>deletedCustomers</span> <span class=o>=</span> <span class=n>Flux</span><span class=o>.</span><span class=na>merge</span><span class=o>(</span><span class=n>deletedCustomers</span><span class=o>,</span> <span class=n>invoicesDeleted</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>customer</span> <span class=o>-&gt;</span> <span class=o>(</span><span class=n>Customer</span><span class=o>)</span><span class=n>customer</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>deletedCustomers</span><span class=o>.</span><span class=na>then</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>As <code>.autoConnect(2)</code> is used, the subscription to the repository publisher only happens if two subscriptions have happened downstream. This requires the <code>reactiveAccountService</code> and <code>reactiveInvoiceService</code> to return a <code>Mono&lt;Void></code> which completes once the given input flux is consumed completely, which ensures one subscription. The second subscription is achieved by merging the output together with original input flux.</p><p>The output is then as expected</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Subscribed to repository source
</span></span><span class=line><span class=cl>Generating 0
</span></span><span class=line><span class=cl>Deleting invoice InvoiceId[id=Invoice CustomerId[id=Customer 0]]
</span></span><span class=line><span class=cl>Deleting account AccountId[id=Account CustomerId[id=Customer 0]]
</span></span><span class=line><span class=cl>Generating 1
</span></span><span class=line><span class=cl>Deleting invoice InvoiceId[id=Invoice CustomerId[id=Customer 1]]
</span></span><span class=line><span class=cl>Deleting account AccountId[id=Account CustomerId[id=Customer 1]]
</span></span><span class=line><span class=cl>Generating 2
</span></span><span class=line><span class=cl>Deleting invoice InvoiceId[id=Invoice CustomerId[id=Customer 2]]
</span></span><span class=line><span class=cl>Deleting account AccountId[id=Account CustomerId[id=Customer 2]]
</span></span></code></pre></td></tr></table></div></div><p>At this point, the <code>reactiveAccountService</code> and <code>reactiveInvoiceService</code> could now also decide to .buffer their own given flux if they wanted to delete the given accounts or invoices in batch. Each implementation is free to choose a different buffer (or batch) size on its own. This is an advantage over the non-reactive implementation, where all items have been collected in one large list beforehand and are then given in bulk to the <code>accountService</code> and <code>invoiceService</code>.</p><h3 id=introducing-a-utility-method>Introducing a utility method</h3><p>The above working solution has already been written such that a generic utility method can be extracted</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ReactiveUtil</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=nf>ReactiveUtil</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// static methods only
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>dispatchToWorker</span><span class=o>(</span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>input</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                               <span class=n>Function</span><span class=o>&lt;</span><span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;,</span>
</span></span><span class=line><span class=cl>                                               <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;&gt;</span> <span class=n>worker</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Flux</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>splitFlux</span> <span class=o>=</span> <span class=n>input</span><span class=o>.</span><span class=na>publish</span><span class=o>().</span><span class=na>autoConnect</span><span class=o>(</span><span class=mi>2</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Mono</span><span class=o>&lt;</span><span class=n>Void</span><span class=o>&gt;</span> <span class=n>workerResult</span> <span class=o>=</span> <span class=n>worker</span><span class=o>.</span><span class=na>apply</span><span class=o>(</span><span class=n>splitFlux</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Flux</span><span class=o>.</span><span class=na>mergeDelayError</span><span class=o>(</span><span class=n>Queues</span><span class=o>.</span><span class=na>XS_BUFFER_SIZE</span><span class=o>,</span> <span class=n>workerResult</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>splitFlux</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>ReactiveUtil</span><span class=o>::</span><span class=n>uncheckedCast</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;unchecked&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>uncheckedCast</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>(</span><span class=n>T</span><span class=o>)</span><span class=n>o</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Instead of <code>Flux.merge</code>, <code>Flux.mergeDelayError</code> is used which handles the situation better if the worker returns an error for completion. In this particular use case, it’s desired that deletion continues even if one worker fails to do so. The worker is also expected to return a <code>Mono&lt;Void></code> which completes once the input flux is consumed. The simplest worker function would thus be <code>Flux::then</code>.</p><p>The unchecked cast could not be removed, but in this circumstance it should never fail as the merged flux can only contain items of type <code>T</code>, as the <code>Mono&lt;Void></code> just completes with no items at all.</p><p>A usage example in a more reactive style of coding would be</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>return</span> <span class=n>reactiveCustomerRepository</span><span class=o>.</span><span class=na>deleteCustomersByIds</span><span class=o>(</span><span class=n>customerIds</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>transform</span><span class=o>(</span><span class=n>deletedCustomers</span> <span class=o>-&gt;</span> <span class=n>ReactiveUtil</span><span class=o>.</span><span class=na>dispatchToWorker</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>deletedCustomers</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>workerFlux</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>AccountId</span><span class=o>&gt;</span> <span class=n>toBeDeletedAccounts</span> <span class=o>=</span> <span class=n>workerFlux</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>Customer</span><span class=o>::</span><span class=n>getAccount</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>reactiveAccountService</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>deleteAccounts</span><span class=o>(</span><span class=n>toBeDeletedAccounts</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>transform</span><span class=o>(</span><span class=n>deletedCustomers</span> <span class=o>-&gt;</span> <span class=n>ReactiveUtil</span><span class=o>.</span><span class=na>dispatchToWorker</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>deletedCustomers</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                <span class=n>workerFlux</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Flux</span><span class=o>&lt;</span><span class=n>InvoiceId</span><span class=o>&gt;</span> <span class=n>toBeDeletedInvoices</span> <span class=o>=</span> <span class=n>workerFlux</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>flatMap</span><span class=o>(</span><span class=n>customer</span> <span class=o>-&gt;</span> <span class=n>Flux</span><span class=o>.</span><span class=na>fromIterable</span><span class=o>(</span><span class=n>customer</span><span class=o>.</span><span class=na>getInvoices</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>reactiveInvoiceService</span>
</span></span><span class=line><span class=cl>                            <span class=o>.</span><span class=na>deleteInvoices</span><span class=o>(</span><span class=n>toBeDeletedInvoices</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>))</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=na>then</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>Note the pattern of using <code>.transform</code> together with the utility function. The output is the same as the working example above.</p><h2 id=conclusion>Conclusion</h2><p>Reactive applications should still follow the overall architecture of larger applications, which are usually split into several components for each functional domain. This approach clashes with reactive programming, where usually one stream is mapped with operators and dispatching work to other services is not easily supported. This post shows a solution, although usage in Java of the presented utility function is still somewhat clumsy.</p><p>In Kotlin, the usage of extension functions would make this utitilty easier to use without the rather clumsy <code>.transform</code> pattern above.</p><p>It’s also open if there’s a better solution for the presented problem. Comments welcome!</p></div><div class='post_extra mb-2'><div class='share copy'></div><a href="http://twitter.com/share?text=Check out this post on the QAware Engineering Blog about How%20to%20dispatch%20flux%20to%20worker%20in%20Reactor&url=https%3a%2f%2fblog.qaware.de%2fposts%2fdispatch-flux-in-reactor%2f&hashtags=Flux%2cReactor%2cJava%2cReactive"><div class='share twitter'></div></a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fblog.qaware.de%2fposts%2fdispatch-flux-in-reactor%2f"><div class='share linkedin'></div></a><a href="mailto:?subject=How%20to%20dispatch%20flux%20to%20worker%20in%20Reactor&body=Hi,%0D%0A%0D%0ACheck out this post on the QAware Engineering Blog: https%3a%2f%2fblog.qaware.de%2fposts%2fdispatch-flux-in-reactor%2f%0D%0A%0D%0ABest Regards"><div class='share email'></div></a></div><div></div></div></div></div><a href=https://blog.qaware.de/ class=post_nav><span class=post_next>The Latest Posts</span></a></main><footer><div class=footer-container><div class=short-link-area><div class=margin><div class=logo-qaware><a href=/><img src=/images/icons/logo-qaware-white.png alt=QAware width=195 height=43></a></div><div class=clr></div><div class=footer-links><a href=https://www.qaware.de/newsbereich/ class=foot-single-link>News</a>
<a href=https://www.qaware.de/eventkalender/ class=foot-single-link>Eventkalender</a>
<a href=https://www.qaware.de/kontakt/ class=foot-single-link>Kontakt</a><div class=footer-table><a href=https://info.qaware.de/en/legal-notice class="foot-single-link footer-table-cell">Legal Notice</a>&nbsp;|&nbsp;
<a href=https://info.qaware.de/en/legal-notice class="foot-single-link footer-table-cell">Privacy</a></div></div><nav class=nav-social><ul class=e-social id=c1375><li><a href=http://www.kununu.com/qaware title=Kununu target=_blank class="icon icon-kununu-outline"><span></span></a></li><li><a href=https://www.twitter.com/qaware title=Twitter target=_blank class="icon icon-twitter-outline"><span></span></a></li><li><a href=https://www.linkedin.com/company/qaware-gmbh title=LinkedIn target=_blank class="icon icon-linkedin-outline"><span></span></a></li><li><a href=https://github.com/qaware title=GitHub target=_blank class="icon icon-git-outline"><span></span></a></li><li><a href=https://www.slideshare.net/qaware title=SlideShare target=_blank class="icon icon-slideshare-outline"><span></span></a></li><li><a href=https://www.youtube.com/channel/UCmNf72xADnO57idipq9jvMg title=Youtube target=_blank class="icon icon-youtube-outline"><span></span></a></li></ul></nav><div class=clr></div></div></div><nav class="footer-nav nav-area"><ul class=margin><li><a href=https://www.qaware.de/leistung/>Leistung</a><ul><li><a href=https://www.qaware.de/leistung/#diagnose>Diagnose</a></li><li><a href=https://www.qaware.de/leistung/#sanierung>Sanierung</a></li><li><a href=https://www.qaware.de/leistung/#leistung-exploration>Exploration</a></li><li><a href=https://www.qaware.de/leistung/#leistung-realisierung>Realisierung</a></li><li><a href=https://www.qaware.de/leistung/#kunden>Referenzen</a></li></ul></li><li><a href=https://www.qaware.de/karriere/>Karriere</a><ul><li><a href=https://www.qaware.de/karriere/#arbeitsplatz>Arbeitsplatz</a></li><li><a href=https://www.qaware.de/karriere/#kultur>Kultur</a></li><li><a href=https://www.qaware.de/karriere/#entwicklung>Entwicklung</a></li><li><a href=https://www.qaware.de/karriere/#weiterbildung>Weiterbildung</a></li><li><a href=https://www.qaware.de/karriere/#jobs>Jobs</a></li><li><a href=https://www.qaware.de/karriere/#veranstaltungen>Veranstaltungen</a></li></ul></li><li><a href=https://www.qaware.de/wissen/>Wissen</a><ul><li><a href=https://www.qaware.de/wissen/#manifest>Manifest</a></li><li><a href=https://www.qaware.de/wissen/#blog>Blog</a></li><li><a href=https://www.qaware.de/wissen/#konferenzen>Konferenzen</a></li><li><a href=https://www.qaware.de/wissen/#fachartikel>Fachartikel</a></li><li><a href=https://www.qaware.de/wissen/#buecher>Bücher</a></li><li><a href=https://www.qaware.de/wissen/#vorlesungen>Vorlesungen</a></li><li><a href=https://www.qaware.de/wissen/#forschung>Forschung</a></li></ul></li><li><a href=https://www.qaware.de/unternehmen/>Unternehmen</a><ul><li><a href=https://www.qaware.de/unternehmen/#unternehmenskultur>Mission</a></li><li><a href=https://www.qaware.de/unternehmen/#kennzahlen>Kennzahlen</a></li><li><a href=https://www.qaware.de/unternehmen/#management>Management</a></li></ul></li></ul></nav></div></footer><script src=https://blog.qaware.de/js/index.min.791bb653c336adab277d58e8a52b9e81250276bb14f8fced435ae89f02d3155ae233664425075d8cb7ef5444d08a4a2276ee6bf16082d57c12c85f010e25412a.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-538827-3"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-538827-3")</script></body></html>